# node-red-contrib-ocpp2

[![NPM](https://nodei.co/npm/node-red-contrib-ocpp2.png)](https://nodei.co/npm/node-red-contrib-ocpp2/)

[Node-Red][4] nodes for communicating with Charge Systems (EVSEs) and Charge Station Central Managers via the [Open Charge Point 2.x Protocol][6] (hereafter OCPP). These node-red nodes
allow you to take on the role of a Central System (CS) or Charge Point (CP).

Based on the [OCPP 2.0.1][6] specifications utilizing the JavaScript Object Notation (hereafter JSON) protocols.

> # NOTE:
>
> These nodes are currently still at a **beta** release level.

# Install

Run the following command in the root directory of your Node-RED install

    npm install @anl-ioc/node-red-contrib-ocpp2

or use the Node-Red `Manage Palette` menu item to install `@anl-ioc/node-red-contrib-ocpp2`

Once installed in Node-Red, you will find the 2 nodes in the node palette under the "OCPP" tab. If you had previously installed node-red-contrib-ocpp (the OCPP 1.6 version), then the new OCPP 2.0.1 nodes will be added to the same tab.
They have a slightly differnt shade of cyan as their color to make them stand out. The OCPP 1.6 nodes are not required to make the 2.0.1 nodes work.

# Requirements

The package currently requires

- [Node.js 16.20.0][1] or higher.
- [Node-Red 3.0][4] or higher.

# Nodes

- [CS](#cs)
- [CSMS](#cs-server)
- [examples](#examples)

---

## CS

**User Generated Message IDs**

For all request nodes the option exists to also pass in a user generated message ID that will be used to identify the message.

```javascript
{
    "command": "Reset",
    "data" : { "type" : "Hard" },
    "MessageId": "12345678"
}
```

This may make it easier for you to identify and track your message throughout your flows. By default, the node modules internally generate a unique id for request messages based on [UUID v4](http://www.ietf.org/rfc/rfc4122.txt)

**Output**

The output returned by the node has the following message format:

```javascript
{
    "ocpp": {
        "command": "<the command being responded to>",
        "chargeBoxIdentity": "<the name of the EVSE charge box responding>",
        "url": "<the URL of the responding charge box>",
        "data": "<the data that was sent with the command to make the request>"
    },
    "payload": {
        "command": "<the command being responded to>",
        "key": "value"
    }
}
```

---

## CS server

The ocpp-server node will listen for incoming requests coming from the EVSE charge points that are targeting its address. It is capable of receiving messages via 1.5 SOAP, 1.6 SOAP, and 1.6 JSON if the protocols are enabled in its configuration.
When the ocpp-server node receives a message, it will output a message in the following format:

```javascript
{
    "ocpp": {
        "ocppVersion": "<protocol version of message: 1.5, 1.6, or 1.6j>",
        "command": "<the command being requested>",
        "chargeBoxIdentity": "<the name of the charge box making the request>",
        "From": "<optional address of the incoming request>",
        "MessageID": "<optional incoming request message id generated by the charge box>",
        "messageType": "<only sent if the message is a JSON message. 2=request, 3=reply>"
    },
    "payload": {
        "command": "<the command being requested>",
        "data": "<arguments received with the incoming request command stored in key/value pairs>"
    }
}
```

Here is an example of a OCPP 1.6 JSON Heartbeat request message.

```javascript
{   "ocpp":{
        "ocppVersion": "1.6j",
        "chargeBoxIdentity": "veefil-48310","MessageId": "uuid:f1d11de1-5725-9255-854b-da6542b4d9bb",
        "msgType": 2,
        "command": "Heartbeat"
    },
    "payload":{
        "command": "Heartbeat",
        "data":{}
    },
    "msgId":"e38e0e7f-3db2-4a33-ab80-859175ebfce0","_msgid":"d310afd9.b9de8"
}
```

The incoming messages require a response (sent through the _[server response](#server-response)_ node), and those responses should be sent within
a reasonable amount of time. The ocpp-server node will cancel any outstanding responses after a 2 minute time period. The EVSE side
may timeout awaiting a response even sooner than that depending on their configuration.

---

## server response

To return a response to an incoming EVSE charge point request, you need to pass your message to the _[server response](#server-response)_ node. Since the message
coming out of the ocpp-server node contains information about how to return the response, the message itself should be passed as is through
the node flow with the exception of the msg.payload section. The msg.payload should be modified to contain the response to the incoming request.

For example, to accept a _BootNotification_ request, set the payload of the response as:

```javascript
{
    "status": "Accepted",
    "currentTime": new Date().toISOString(),
    "heartbeatInterval": 60
}
```

(The message being passed from the server contains a unique identifier contained in msg.msgID. This needs to be present in the response message in order for the message to be returned to the proper request)

---

## examples

In the root of the OCPP2 node module folder is a folder named examples. This is where you can find example flows that may be useful in setting up your OCCP situation.
Currently a single example file exists which you can import into node-red that sets up a Central System node with a few basic Charge Point nodes. This is by no means a full production example, but just a starting point for those who may be interested in a way to set up the nodes.

# Author

[Bryan Nystrom][11]

[Argonne National Laboratory][10]

[1]: https://nodejs.org/
[4]: http://nodered.org
[6]: https://openchargealliance.org/protocols/open-charge-point-protocol/
[10]: https://www.anl.gov
[11]: https://github.com/bnystrom
