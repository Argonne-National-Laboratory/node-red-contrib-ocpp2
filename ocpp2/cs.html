<style>
  .header {
    text-decoration: underline;
    font-weight: bold;
    margin-top: 5px;
  }
  .bordered {
    padding-left: 12px;
    padding-top: 4px;
    border: 1px solid lightgrey;
    box-sizing: border-box;
  }
  dt {
    font-weight: bold;
    font-size: larger;
  }
</style>

<script type="text/javascript">
  RED.nodes.registerType("CS", {
    category: "OCPP",
    color: "#16ccff",
    defaults: {
      name: { value: "" },
      csms: { value: "", type: "target-csms", required: true },
      cbId: { value: "", required: true },
      ws_rt_minimum: { value: 10, required: true },
      ws_rt_repeat: { value: 2, required: true },
      ws_rt_rnd_range: { value: 2, required: true },
      auto_connect: { value: true },
      ocpp_logging: { value: false },
      outputs: { value: 1 },
    },
    credentials: {
      csms_pw: { type: "password", required: true },
    },
    inputs: 1,
    //outputs: 3,
    icon: "cs.svg",
    label: function () {
      return this.name || this.cbId || "CS";
    },
    outputLabels: ["all", "link call", "ocpp log"],
    //Functions
    oneditprepare: function () {
      var node = this;
      node.outputs = $("#node-input-ocpp_logging").prop("checked") ? 3 : 2;
      $("#node-input-ocpp_logging").change(function () {
        node.outputs = this.checked ? 3 : 2;
      });
    },
    oneditsave: function () {
      node.outputs = $("#node-input-ocpp_logging").prop("checked") ? 3 : 2;
    },
  });
</script>

<script type="text/x-red" data-template-name="CS">

  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-id-card-o"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name (defaults to cbId)" >
  </div>

  <div class="form-row">
      <label for="node-input-cbId"><i class="fa fa-plug"></i> cbId</label>
      <input type="text" id="node-input-cbId" placeholder="CS Charge Box Id" >
  </div>
  <div class="form-row">
      <label for="node-input-ocpp_logging"><i class="icon-tag"></i> OCPP Logging</label>
      <input type="checkbox" id="node-input-ocpp_logging" >
  </div>
  <div class="header">Target CSMS</div>
  <div class="form-row">
      <label for="node-input-csms"><i class="fa fa-globe"></i> Url</label>
      <input type="text" id="node-input-csms" placeholder="Target CSMS" >
  </div>
  <div class="form-row">
      <label for="node-input-auto_connect"><i class="icon-tag"></i> Auto Connect</label>
      <input type="checkbox" id="node-input-auto_connect" >
  </div>
  <div class="header">Basic Auth</div>
  <div class="form-row">
    <label for="node-input-csms_pw"><i class="fa fa-lock"></i> Password</label>
      <input type="password" id="node-input-csms_pw" placeholder="password" >
  </div>
  <div class="header">Retry Backoff</div>
  <div class="form-row">
      <label for="node-input-ws_rt_minimum"><i class="fa fa-clock-o"></i> Min (sec)</label>
      <input type="number" id="node-input-ws_rt_minimum" min="0">
  </div>
  <div class="form-row">
      <label for="node-input-ws_rt_repeat"><i class="fa fa-repeat"></i> Times to inc</label>
      <input type="number" id="node-input-ws_rt_repeat" min="0">
  </div>
  <div class="form-row">
      <label for="node-input-ws_rt_rnd_range"><i class="fa fa-random"></i> Max Random Range</label>
      <input type="number" id="node-input-ws_rt_rnd_range" min="0">
  </div>
</script>

<script type="text/markdown" data-help-name="CS">
  OCPP 2.0.1 Charging Station (CS)

  ### Inputs

  1. OCPP messages `msg.payload`
     : command (string) : valid OCPP 2.x command used in REQUESTS
     : msgType (int) : 2 = REQUEST, 3 = RESPONSE, 4 = CALLERROR
     : data (object) : valid OCPP 2.x command data
     : customData (any) : user custom data returned with matching RESPONSE message

  ### Outputs

  1. Standard Output
     : payload (object) : incoming REQUEST messages and responses from CONTROL messages such as online status

  2. Linked Output
     : payload (object) : messages that should be passed to a node-red 'link out' node set to "Return to calling link node", mainly incoming RESPONSE messages

  3. OCPP Log Output
     : payload (object) : Raw output of sent and received ocpp messages. Only viable/available if logging is enabled in config

  ### Details

  `msg.payload` is used in the payload
</script>

<!--
/***********************************************************************
  * THis sets up the configuration node for target CSMSs
  *
***********************************************************************/
-->

<script type="text/javascript">
  RED.nodes.registerType("target-csms", {
    category: "config",
    defaults: {
      name: { value: "", required: false },
      url: { value: "", required: true },
    },
    label: function () {
      return this.name || this.url || "CSMS";
    },
  });
</script>

<script type="text/x-red" data-template-name="target-csms">
  <div class="header">Target CSMS</div>
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-id-card-o"></i> Name</label>
    <input type="text" id="node-config-input-name", placeholder="Name of CSMS"/>
  </div>
  <div class="form-row">
    <label for="node-config-input-url"><i class="fa fa-globe"></i> URL</label>
    <input type="text" id="node-config-input-url", placeholder="ws://localhost:1234/ocpp"/>
  </div>
</script>

<script type="text/x-red" data-help-name="target-csms">

  <p>Configures the taget CSMS</p>
  <h3>Configuration Settings</h3>

  <dl>
    <dt>Name:</dt>
    <dd>Give a unique name to help identify this target CSMS</dd>
    <dt>URL</dt>
    <dd>Give the target CSMS URL. Must start with 'ws://' or 'wss://'. Should include the port and route if applicable.<br>
    <i>Example: ws://my_csms.com:8888/ocpp</i></dd>
  </dl>
</script>

<!---

  Title: Node-Red-Contrib-OCPP2
  Author: Bryan Nystrom
  Company: Argonne National Laborator

  File: cs.html
  Description: Config file for CS (Charge Station) node.

--->
